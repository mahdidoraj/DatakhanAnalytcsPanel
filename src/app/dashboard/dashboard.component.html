<div class="container-fluid">
	<div class="row g-3" *ngIf="!loadingKpi(); else kpiSkeletons">
		<div class="col-12 col-sm-6 col-xl-3" *ngFor="let k of kpis()">
			<ws-kpi-card [title]="k.title" [value]="k.value" [unit]="k.unit" [delta]="k.delta" [icon]="k.icon"></ws-kpi-card>
		</div>
	</div>
	<ng-template #kpiSkeletons>
		<ws-skeleton [count]="4"></ws-skeleton>
	</ng-template>

	<!-- CHARTS -->
	<div class="row g-3 mt-1">
		<div class="col-12 col-lg-6">
			<p-card class="shadow-sm border-0 rounded-4">
				<div class="card-header bg-transparent border-0 fw-semibold">احساسات در بازه زمانی</div>
				<div class="card-body">
					<div class="chart-h" *ngIf="!loadingCharts(); else chartSk1">
						<apx-chart
							[series]="timeSeries"
							[chart]="chartArea"
							[xaxis]="xaxisTime"
							[stroke]="strokeSmooth"
							[dataLabels]="dataLabelsOff"
							[tooltip]="tooltipShared"
							[fill]="fillGradient"
							[legend]="legendTop">
						</apx-chart>
					</div>
					<ng-template #chartSk1>
						<ws-skeleton [count]="1"></ws-skeleton>
					</ng-template>
				</div>
			</p-card>
		</div>

		<div class="col-12 col-lg-6">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-header bg-transparent border-0 fw-semibold">اینگیجمنت هفتگی بر اساس شبکه</div>
				<div class="card-body">
					<div class="chart-h" *ngIf="!loadingCharts(); else chartSk2">
						<apx-chart
							[series]="engSeries"
							[chart]="chartBar"
							[xaxis]="xaxisWeeks"
							[legend]="legendTop"
							[dataLabels]="dataLabelsOff"
							[stroke]="strokeSmooth">
						</apx-chart>
					</div>
					<ng-template #chartSk2>
						<ws-skeleton [count]="1"></ws-skeleton>
					</ng-template>
				</div>
			</div>
		</div>

		<div class="col-12 col-xl-4">
			<div class="card shadow-sm border-0 rounded-4 h-100">
				<div class="card-header bg-transparent border-0 fw-semibold">سهم شبکه‌ها</div>
				<div class="card-body">
					<div class="chart-h" *ngIf="!loadingCharts(); else chartSk3">
						<apx-chart
							[series]="shareSeries"
							[labels]="shareLabels"
							[chart]="chartDonut"
							[legend]="legendRight"
							[responsive]="donutResponsive">
						</apx-chart>
					</div>
					<ng-template #chartSk3>
						<ws-skeleton [count]="1"></ws-skeleton>
					</ng-template>
				</div>
			</div>
		</div>

		<div class="col-12 col-xl-8">
			<div class="card shadow-sm border-0 rounded-4 h-100">
				<div class="card-header bg-transparent border-0 fw-semibold d-flex align-items-center justify-content-between">
					کلمات کلیدی
					<span class="small text-muted">۱۵ مورد برتر</span>
				</div>
				<div class="card-body">
					<div class="d-flex flex-wrap gap-2" *ngIf="!loadingCharts(); else keysSk">
						<p-chip *ngFor="let r of rows() | slice:0:15" [label]="r.keywords[0]" icon="fas fa-hashtag"></p-chip>
					</div>
					<ng-template #keysSk>
						<ws-skeleton [count]="3"></ws-skeleton>
					</ng-template>
				</div>
			</div>
		</div>
	</div>

	<!-- TABLE / EMPTY STATE -->
	<div class="row g-3 mt-1">
		<div class="col-12">
			<div class="card shadow-sm border-0 rounded-4">
				<div class="card-header bg-transparent border-0">
					<div class="d-flex flex-wrap align-items-center gap-2">
						<div class="input-group input-group-sm w-auto">
							<span class="input-group-text bg-light"><i class="fas fa-hashtag"></i></span>
							<p-dropdown styleClass="form-select" [options]="['X','Instagram','Facebook']"
							            [formControl]="filters.controls.networks" placeholder="شبکه‌ها"></p-dropdown>
						</div>
						<div class="w-auto">
							<p-multiSelect [options]="['@brand1','@brand2']"
							               [formControl]="filters.controls.accounts"
							               defaultLabel="اکانت‌ها"></p-multiSelect>
						</div>
						<div class="w-auto">
							<p-calendar [selectionMode]="'range'" [showIcon]="true"
							            [formControl]="filters.controls.range"></p-calendar>
						</div>
					</div>
				</div>

				<div class="bg-transparent card-body p-3" *ngIf="loadingTable(); else tableOrEmpty">
					<ws-skeleton [count]="5"></ws-skeleton>
				</div>

				<ng-template #tableOrEmpty>
					<div *ngIf="filteredRows().length===0; else tableBlock" class="">
						<ws-empty-state icon="fas fa-filter"
						                title="نتیجه‌ای یافت نشد"
						                subtitle="فیلترها را تغییر دهید و دوباره تلاش کنید">
						</ws-empty-state>
					</div>
					<ng-template #tableBlock>
						<div class="bg-transparent card-body p-0 d-none d-md-block">
							<p-table
								[value]="filteredRows()"
								[paginator]="true" [rows]="10"
								[rowHover]="true" [responsiveLayout]="'scroll'">
								<ng-template pTemplate="header">
									<tr>
										<th class="text-nowrap">تاریخ</th>
										<th>شبکه</th>
										<th>اکانت</th>
										<th>متن</th>
										<th>مدیا</th>
										<th>لایک</th>
										<th>کامنت</th>
										<th>اشتراک</th>
										<th>احساس</th>
										<th></th>
									</tr>
								</ng-template>
								<ng-template pTemplate="body" let-r>
									<tr>
										<td class="text-nowrap">{{ r.datetime | date:'yyyy/MM/dd HH:mm' }}</td>
										<td>
											<p-tag [value]="r.network"></p-tag>
										</td>
										<td class="text-nowrap">{{ r.account }}</td>
										<td>
												<span [pTooltip]="r.text"
												      tooltipPosition="top">{{ r.text | slice:0:70 }}{{ r.text?.length > 70 ? '…' : '' }}</span>
											<div class="mt-2 d-flex flex-wrap gap-2">
												<p-chip *ngFor="let k of r.keywords" [label]="k"
												        [styleClass]="'p-chip-sm'"></p-chip>
											</div>
										</td>
										<td>{{ r.mediaType }}</td>
										<td>{{ r.likes | number }}</td>
										<td>{{ r.comments | number }}</td>
										<td>{{ r.shares | number }}</td>
										<td>
											<p-tag
												[severity]="r.sentiment==='positive'?'success':(r.sentiment==='negative'?'danger':'info')"
												[value]="r.sentiment"></p-tag>
										</td>
										<td class="text-end">
											<button pButton icon="fas fa-eye"
											        class="btn btn-sm p-button-text  btn-outline-secondary"
											        (click)="viewPost(r)"></button>
										</td>
									</tr>
								</ng-template>
							</p-table>
						</div>

						<!-- Mobile list -->
						<div class="bg-transparent card-body d-md-none">
							<div class="row g-3">
								<div class="col-12" *ngFor="let r of filteredRows() | slice:0:10">
									<div class="border rounded-3 p-3">
										<div class="d-flex justify-content-between align-items-center mb-1">
											<p-tag [value]="r.network"></p-tag>
											<small class="text-muted">{{ r.datetime | date:'MM/dd HH:mm' }}</small>
										</div>
										<div class="small text-muted mb-1"><i class="fas fa-user ms-1"></i>{{ r.account }}
										</div>
										<div class="mb-2">{{ r.text }}</div>
										<div class="d-flex gap-3 small text-muted mb-2 flex-wrap">
											<span><i class="fas fa-heart ms-1"></i>{{ r.likes }}</span>
											<span><i class="fas fa-comments ms-1"></i>{{ r.comments }}</span>
											<span><i class="fas fa-share-alt ms-1"></i>{{ r.shares }}</span>
										</div>
										<div class="d-flex flex-wrap gap-2 mb-2">
											<p-chip *ngFor="let k of r.keywords" [label]="k"></p-chip>
										</div>
										<div class="d-flex justify-content-between align-items-center">
											<p-tag
												[severity]="r.sentiment==='positive'?'success':(r.sentiment==='negative'?'danger':'info')"
												[value]="r.sentiment"></p-tag>
											<button pButton label="نمایش" icon="fas fa-eye"
											        class="btn btn-sm btn-outline-secondary" (click)="viewPost(r)"></button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</ng-template>
				</ng-template>
			</div>
		</div>
	</div>
</div>
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasFilters">
	<div class="offcanvas-header">
		<h5 class="offcanvas-title">فیلترها</h5>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
	</div>
	<div class="offcanvas-body d-flex flex-column gap-3">
		<div>
			<label class="form-label">زبان</label>
			<p-dropdown [options]="['fa','en']" [formControl]="filters.controls.lang" styleClass="w-100"></p-dropdown>
		</div>
		<div>
			<label class="form-label">شبکه‌ها</label>
			<p-multiSelect [options]="['X','Instagram','Facebook']" [formControl]="filters.controls.networks"
			               defaultLabel="انتخاب شبکه‌ها" styleClass="w-100"></p-multiSelect>
		</div>
		<div>
			<label class="form-label">احساس</label>
			<p-multiSelect [options]="['positive','neutral','negative']" [formControl]="filters.controls.sentiments"
			               defaultLabel="انتخاب احساس" styleClass="w-100"></p-multiSelect>
		</div>
		<div>
			<label class="form-label">مدیا</label>
			<p-multiSelect [options]="['text','image','video','link']" [formControl]="filters.controls.media"
			               defaultLabel="نوع مدیا" styleClass="w-100"></p-multiSelect>
		</div>
		<div>
			<label class="form-label">بازه زمانی</label>
			<p-calendar [selectionMode]="'range'" [showIcon]="true" [formControl]="filters.controls.range"
			            styleClass="w-100"></p-calendar>
		</div>
		<div class="mt-2 d-flex gap-2">
			<button class="btn btn-primary w-100" data-bs-dismiss="offcanvas">اعمال</button>
			<button class="btn btn-outline-secondary w-100" type="button">ریست</button>
		</div>
	</div>
</div>
<p-dialog
	[visible]="showPost()"
	(visibleChange)="showPost.set($event)"
	[modal]="true"
	[style]="{width:'min(720px, 96vw)'}"
	[dismissableMask]="true"
	header="جزئیات پست">
	<ng-template pTemplate="content">
		<div class="container-fluid">
			<div class="row g-2 align-items-center">
				<div class="col">
					<div class="small text-muted"><i class="fas fa-user ms-1"></i>{{ selectedPost?.account }}</div>
					<div class="small text-muted">{{ selectedPost?.datetime | date:'medium' }}</div>
				</div>
				<div class="col-auto">
					<p-tag [value]="selectedPost?.network"></p-tag>
				</div>
			</div>
			<hr>
			<p class="mb-2">{{ selectedPost?.text }}</p>
			<div class="d-flex flex-wrap gap-2">
				<p-chip *ngFor="let k of selectedPost?.keywords" [label]="k"></p-chip>
			</div>
			<div class="d-flex gap-3 small text-muted mt-3 flex-wrap">
				<span><i class="fas fa-heart ms-1"></i>{{ selectedPost?.likes }}</span>
				<span><i class="fas fa-comments ms-1"></i>{{ selectedPost?.comments }}</span>
				<span><i class="fas fa-share-alt ms-1"></i>{{ selectedPost?.shares }}</span>
			</div>
		</div>
	</ng-template>
</p-dialog>
